{% extends "_layout.html" %}

{% block title %}Quản lý Sinh viên{% endblock %}

{% block content %}
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
        <h2>Quản lý Sinh viên</h2>
        <a href="{{ url_for('admin_add_student') }}" style="text-decoration: none; padding: 10px 15px; background: #5cb85c; color: white; border-radius: 5px; height: fit-content;">Thêm Sinh viên mới</a>
    </div>

    <style>
        .filter-form {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px 20px 5px 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .filter-grid div {
            display: flex;
            flex-direction: column;
        }
        .filter-grid label {
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .filter-grid input, .filter-grid select {
            width: 100%; /* Ghi đè style mặc định */
        }
        /* CẬP NHẬT CSS CHO KHỐI NÚT BẤM */
        .filter-buttons {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
            display: flex; /* Dùng flexbox */
            align-items: center;
            gap: 10px; /* Khoảng cách giữa các nút */
        }
        .filter-buttons input[type="submit"] {
            background-color: #0275d8;
        }
        .filter-buttons a {
            text-decoration: none;
            color: #d9534f;
            margin-left: 0; /* Xóa margin cũ */
        }
        /* Nút Xuất Excel (đẩy về bên phải) */
        .btn-export {
            background: #5cb85c; 
            color: white; 
            margin-left: auto; /* Tự động đẩy về bên phải */
            text-decoration: none;
            padding: 10px 15px; /* Thêm padding cho giống nút */
            border-radius: 5px;
            font-size: 14px;
        }
    </style>
    
    <form class="filter-form" method="GET" action="{{ url_for('admin_manage_students') }}">
        <div class="filter-grid">
            <div>
                <label for="ma_sv">Tìm theo Mã SV:</label>
                <input type="text" name="ma_sv" id="ma_sv" value="{{ search_params.ma_sv }}">
            </div>
            <div>
                <label for="ho_ten">Tìm theo Tên SV:</label>
                <input type="text" name="ho_ten" id="ho_ten" value="{{ search_params.ho_ten }}">
            </div>
            <div>
                <label for="lop">Lọc theo Lớp:</label>
                <select name="lop" id="lop">
                    <option value="">-- Tất cả Lớp --</option>
                    {% for lop in danh_sach_lop %}
                        <option value="{{ lop }}" {% if lop == search_params.lop %}selected{% endif %}>{{ lop }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="khoa">Lọc theo Khoa:</label>
                <select name="khoa" id="khoa">
                    <option value="">-- Tất cả Khoa --</option>
                    {% for khoa in danh_sach_khoa %}
                        <option value="{{ khoa }}" {% if khoa == search_params.khoa %}selected{% endif %}>{{ khoa }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="filter-buttons">
            <input type="submit" value="Tìm kiếm / Lọc">
            
            <a href="{{ url_for('admin_manage_students') }}">Xóa bộ lọc</a>
            
            <a href="{{ url_for('admin_export_students_excel', 
                        ma_sv=search_params.ma_sv, 
                        ho_ten=search_params.ho_ten, 
                        lop=search_params.lop, 
                        khoa=search_params.khoa) }}" 
               class="btn-export"> Xuất Excel (Danh sách này)
            </a>
        </div>
    </form>
    <table class="data-table" style="margin-top: 20px;"> <thead>
        <thead>
            <tr>
                <th>Mã SV</th>
                <th>Họ tên</th>
                <th>Ngày sinh</th>
                <th>Lớp</th>
                <th>Khoa</th>
                <th style="width: 150px;">Hành động</th>
            </tr>
        </thead>
        <tbody>
            {% for sv in students %}
            <tr>
                <td>{{ sv.ma_sv }}</td>
                <td>{{ sv.ho_ten }}</td>
                <td>{{ sv.ngay_sinh | formatDate('dd-MM-yyyy') if sv.ngay_sinh else '' }}</td>
                <td>{{ sv.lop }}</td>
                <td>{{ sv.khoa }}</td>
                
                <td class="action-buttons">
                    
                    <a href="{{ url_for('admin_edit_student', ma_sv=sv.ma_sv) }}" class="btn btn-edit">Sửa</a>
                    
                    <form method="POST" action="{{ url_for('admin_delete_student', ma_sv=sv.ma_sv) }}" 
                          
                          onsubmit="return confirm('Bạn có chắc muốn xóa sinh viên {{ sv.ho_ten }} ({{ sv.ma_sv }})? \n\nCẢNH BÁO: Thao tác này sẽ xóa vĩnh viễn cả TÀI KHOẢN và toàn bộ KẾT QUẢ HỌC TẬP của sinh viên này.');"
                          style="margin: 0;"> 
                        <input type="submit" value="Xóa" class="btn btn-delete">
                    </form>
                </td>
            </tr>
            
            {% else %}
            <tr>
                <td colspan="6">Không tìm thấy sinh viên nào khớp với tiêu chí tìm kiếm.</td>
            </tr>
            {% endfor %}
        </tbody>
        
    </table>
    <table class="data-table" style="margin-top: 20px;">
        <thead>
            </thead>
        <tbody>
            </tbody>
    </table>
{% endblock %}