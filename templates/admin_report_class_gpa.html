{% extends "_layout.html" %}

{% block title %}Báo cáo: GPA theo Lớp{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
         <a href="{{ url_for('admin_reports_index') }}" style="text-decoration: none; color: var(--primary-color); float: right; font-size: 0.9em;">&laquo; Quay lại Danh sách Báo cáo</a>
         Báo cáo 3: Thống kê điểm trung bình (GPA) Lớp
    </div>
    <div class="card-body">

        <form method="GET" action="{{ url_for('admin_report_class_gpa') }}">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                <label for="lop" style="margin-bottom: 0;">Chọn Lớp:</label>
                <select name="lop" id="lop" required onchange="this.form.submit()" style="width: 250px; margin-bottom: 0;">
                    <option value="">-- Vui lòng chọn --</option>
                    {% for lop in danh_sach_lop %}
                        <option value="{{ lop }}" {% if selected_lop == lop %}selected{% endif %}>
                            {{ lop }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </form>

        <hr>

        {% if selected_lop %}
            <h3>Kết quả Thống kê cho Lớp: {{ selected_lop }}</h3>

            <div style="display: flex; gap: 30px; flex-wrap: wrap; margin-top: 20px;">
                <div style="padding: 15px; background-color: #f4f4f4; border-radius: 8px;">
                    <h4 style="margin: 0 0 5px 0;">GPA TB (Hệ 10)</h4>
                    <strong style="font-size: 1.8em; color: #0275d8;">
                        {{ "%.2f"|format(lop_gpa_10) if lop_gpa_10 is not none else 'N/A' }}
                    </strong>
                </div>
                <div style="padding: 15px; background-color: #f4f4f4; border-radius: 8px;">
                    <h4 style="margin: 0 0 5px 0;">GPA TB (Hệ 4)</h4>
                    <strong style="font-size: 1.8em; color: #5cb85c;">
                         {{ "%.2f"|format(lop_gpa_4) if lop_gpa_4 is not none else 'N/A' }}
                    </strong>
                </div>
                </div>

            {% if chart_labels %}
            <hr style="margin: 30px 0;">
            <h3>Biểu đồ Phân bố Sinh viên theo Học lực</h3>
            <div style="max-width: 400px; margin: 20px auto 0 auto;">
                <canvas id="classificationChart"></canvas>
            </div>
            {% else %}
            <p style="margin-top: 20px;">Không có đủ dữ liệu để vẽ biểu đồ phân loại.</p>
            {% endif %}
            {% else %}
            <p style="margin-top: 20px;">Vui lòng chọn một lớp để xem thống kê.</p>
        {% endif %}

    </div> </div> {% if selected_lop and chart_labels %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const labels = {{ chart_labels | tojson | safe }};
    const data = {{ chart_data | tojson | safe }};
    const ctx = document.getElementById('classificationChart')?.getContext('2d'); // Thêm ? để tránh lỗi nếu canvas không tồn tại

    if (ctx && data.length > 0) { // Chỉ vẽ nếu có canvas và dữ liệu
        new Chart(ctx, {
            type: 'pie', // Biểu đồ tròn
            data: {
                labels: labels,
                datasets: [{
                    label: 'Số lượng SV',
                    data: data,
                    backgroundColor: [ // Màu tương ứng với classify_gpa_10
                        'rgba(220, 53, 69, 0.8)',   // Yếu (Red)
                        'rgba(253, 126, 20, 0.8)', // Trung bình (Orange)
                        'rgba(255, 193, 7, 0.8)',   // Khá (Yellow)
                        'rgba(0, 123, 255, 0.8)',  // Giỏi (Blue)
                        'rgba(40, 167, 69, 0.8)'   // Xuất sắc (Green)
                        // Thêm màu nếu cần
                    ],
                    borderColor: '#fff', // Viền trắng giữa các phần
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) { label += ': '; }
                                const value = context.parsed;
                                const sum = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = sum > 0 ? ((value / sum) * 100).toFixed(1) + '%' : '0%';
                                label += `${value} SV (${percentage})`;
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endif %}

{% endblock %}